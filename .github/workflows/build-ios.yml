name: Build & Distribute Flutter iOS (Parent App)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'flutter_parent/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build-ios:
    name: Build iOS & Upload to Firebase
    runs-on: macos-latest

    defaults:
      run:
        working-directory: flutter_parent

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      # Generate iOS platform files since they aren't checked in
      - name: Create Flutter iOS platform
        run: flutter create --platforms=ios .

      - name: Install Flutter dependencies
        run: flutter pub get

      # Firebase config - write GoogleService-Info.plist from secret
      - name: Configure Firebase (iOS)
        run: |
          if [ -n "$GOOGLE_SERVICE_PLIST" ]; then
            echo "$GOOGLE_SERVICE_PLIST" | base64 --decode > ios/Runner/GoogleService-Info.plist
            echo "Firebase config written from secret"
          else
            echo "::warning::No GOOGLE_SERVICE_INFO_PLIST_BASE64 secret set - using placeholder config"
            cat > ios/Runner/GoogleService-Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key><string>placeholder</string>
            <key>GCM_SENDER_ID</key><string>000000000000</string>
            <key>PLIST_VERSION</key><string>1</string>
            <key>BUNDLE_ID</key><string>com.kidsmovies.parent</string>
            <key>PROJECT_ID</key><string>kids-movies-parent</string>
            <key>STORAGE_BUCKET</key><string>kids-movies-parent.appspot.com</string>
            <key>IS_ADS_ENABLED</key><false/>
            <key>IS_ANALYTICS_ENABLED</key><false/>
            <key>IS_APPINVITE_ENABLED</key><false/>
            <key>IS_GCM_ENABLED</key><true/>
            <key>IS_SIGNIN_ENABLED</key><true/>
            <key>GOOGLE_APP_ID</key><string>1:000000000000:ios:0000000000000000</string>
          </dict>
          </plist>
          PLIST
          fi
        env:
          GOOGLE_SERVICE_PLIST: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}

      # Set the iOS bundle identifier and display name
      - name: Set bundle identifier
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.kidsmovies.parent" ios/Runner/Info.plist || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName KidsMovies Parent" ios/Runner/Info.plist || true

      # Install CocoaPods dependencies
      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update || pod install

      # ── Code Signing ──────────────────────────────────────────────
      # Required for Firebase App Distribution (Ad Hoc signing)
      - name: Import signing certificate
        if: env.P12_BASE64 != ''
        env:
          P12_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          echo "$P12_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          rm certificate.p12

      - name: Import provisioning profile
        if: env.PROFILE_BASE64 != ''
        env:
          PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision

      # ── Build ─────────────────────────────────────────────────────
      - name: Build iOS (signed)
        if: env.P12_BASE64 != ''
        env:
          P12_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
        run: flutter build ios --release 2>&1 | tee build.log; exit ${PIPESTATUS[0]}

      - name: Build iOS (no codesign)
        if: env.P12_BASE64 == ''
        env:
          P12_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
        run: |
          echo "::warning::No signing secrets configured - building unsigned (cannot distribute via Firebase)"
          flutter build ios --no-codesign --release 2>&1 | tee build.log; exit ${PIPESTATUS[0]}

      - name: Show build errors on failure
        if: failure()
        run: |
          echo "=== BUILD ERRORS ==="
          grep -i "error" build.log | head -50 || true
          echo "=== LAST 100 LINES ==="
          tail -100 build.log

      # ── Package IPA ───────────────────────────────────────────────
      # xcodebuild -exportArchive is the proper way to create a distributable IPA
      - name: Create ExportOptions.plist
        if: success()
        run: |
          cat > ExportOptions.plist << 'EXPORT'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
          </dict>
          </plist>
          EXPORT

      - name: Export IPA via xcodebuild
        if: success() && env.P12_BASE64 != ''
        env:
          P12_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
        run: |
          # Archive
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $PWD/build/Runner.xcarchive \
            archive -allowProvisioningUpdates || true

          # Export IPA
          if [ -d "build/Runner.xcarchive" ]; then
            xcodebuild -exportArchive \
              -archivePath $PWD/build/Runner.xcarchive \
              -exportOptionsPlist ../ExportOptions.plist \
              -exportPath $PWD/build/ipa \
              -allowProvisioningUpdates
            cp build/ipa/*.ipa ../KidsMoviesParent.ipa 2>/dev/null || true
          fi
          cd ..

          # Fallback: package from .app bundle if xcodebuild export didn't produce IPA
          if [ ! -f "KidsMoviesParent.ipa" ]; then
            APP_PATH="build/ios/iphoneos/Runner.app"
            if [ -d "$APP_PATH" ]; then
              mkdir -p Payload
              cp -r "$APP_PATH" Payload/
              zip -r KidsMoviesParent.ipa Payload
              rm -rf Payload
            fi
          fi

      - name: Package IPA (unsigned fallback)
        if: success() && env.P12_BASE64 == ''
        env:
          P12_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          if [ -d "$APP_PATH" ]; then
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/
            zip -r KidsMoviesParent.ipa Payload
            rm -rf Payload
          fi

      # ── Upload artifact ───────────────────────────────────────────
      - name: Upload iOS IPA
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: KidsMoviesParent-iOS
          path: flutter_parent/KidsMoviesParent.ipa
          retention-days: 30
          if-no-files-found: warn

      # ── Firebase App Distribution ─────────────────────────────────
      - name: Upload to Firebase App Distribution
        if: success() && env.FIREBASE_TOKEN != ''
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_CLI_TOKEN }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          if [ ! -f "KidsMoviesParent.ipa" ]; then
            echo "::warning::No IPA file found, skipping Firebase distribution"
            exit 0
          fi

          # Install Firebase CLI
          curl -sL https://firebase.tools | bash

          # Upload to Firebase App Distribution
          firebase appdistribution:distribute KidsMoviesParent.ipa \
            --app "$FIREBASE_APP_ID" \
            --token "$FIREBASE_TOKEN" \
            --groups "testers" \
            --release-notes "Build from commit ${{ github.sha }} on branch ${{ github.ref_name }}"

      # ── Cleanup ───────────────────────────────────────────────────
      - name: Clean up keychain
        if: always()
        run: security delete-keychain build.keychain 2>/dev/null || true
